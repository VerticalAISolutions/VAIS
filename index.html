<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Triple Synthesizer with Freesound</title>
    <style>
        /* ... (Your existing CSS styles) ... */
    </style>
</head>
<body>
    <div class="synth-container">
        </div>

    <div class="freesound-section">
        </div>

    <script>
        class Synthesizer {
            constructor(id) {
                this.id = id;
                this.isPlaying = false;
                this.currentWaveform = 'sine';
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                this.oscillator = null;
                this.gainNode = null;
                this.analyser = this.audioContext.createAnalyser();
                this.analyser.fftSize = 2048;
                this.bufferLength = this.analyser.frequencyBinCount;
                this.dataArray = new Uint8Array(this.bufferLength);
                this.visualizer = document.getElementById(`visualizer${this.id}`);
                this.canvas = document.createElement('canvas');
                this.canvasCtx = this.canvas.getContext('2d');
                this.visualizer.appendChild(this.canvas);
                this.canvas.width = this.visualizer.offsetWidth;
                this.canvas.height = this.visualizer.offsetHeight;

                this.gainNode = this.audioContext.createGain();
                this.gainNode.connect(this.analyser);
                this.analyser.connect(this.audioContext.destination);
                this.gainNode.gain.value = 0; // Initialize volume to 0

                this.setupEventListeners();
                this.drawVisualizer();
            }

            createOscillator() {
                if (this.oscillator) {
                    this.oscillator.stop();
                    this.oscillator.disconnect();
                }

                this.oscillator = this.audioContext.createOscillator();
                this.oscillator.type = this.currentWaveform;
                this.oscillator.frequency.value = document.getElementById(`frequency${this.id}`).value;
                this.oscillator.connect(this.gainNode); // Connect to gain node

                // Smooth volume transition (using exponential ramp for better perceived smoothness)
                this.gainNode.gain.setValueAtTime(0.0001, this.audioContext.currentTime); // A tiny value to avoid zero
                this.gainNode.gain.exponentialRampToValueAtTime(1, this.audioContext.currentTime + 0.05); // Ramp up quickly

                this.oscillator.start();
            }

            setupEventListeners() {
                const playButton = document.getElementById(`playButton${this.id}`);
                const frequencySlider = document.getElementById(`frequency${this.id}`);
                const volumeSlider = document.getElementById(`volume${this.id}`);
                const frequencyValue = document.getElementById(`frequencyValue${this.id}`);
                const volumeValue = document.getElementById(`volumeValue${this.id}`);
                const waveButtons = document.querySelectorAll(`.synth-${this.id} .button`);

                playButton.addEventListener('click', () => {
                    this.isPlaying = !this.isPlaying;
                    playButton.textContent = this.isPlaying ? "Stop" : "Start";

                    if (this.isPlaying) {
                        this.createOscillator();
                    } else {
                        this.oscillator.stop();
                        this.oscillator.disconnect();
                        this.oscillator = null;
                    }
                });

                frequencySlider.addEventListener('input', () => {
                    if (this.oscillator) {
                        this.oscillator.frequency.value = frequencySlider.value;
                    }
                    frequencyValue.textContent = `${frequencySlider.value} Hz`;
                });

                volumeSlider.addEventListener('input', () => {
                    this.gainNode.gain.value = volumeSlider.value / 100;
                    volumeValue.textContent = `${volumeSlider.value}%`;
                });

                waveButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        waveButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        this.currentWaveform = button.dataset.wave;
                        if (this.isPlaying) {
                            this.createOscillator(); // Recreate oscillator with new waveform
                        }
                    });
                });
            }

            drawVisualizer() {
                this.analyser.getByteTimeDomainData(this.dataArray);

                this.canvasCtx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.canvasCtx.beginPath();
                const sliceWidth = this.canvas.width * 1.0 / this.bufferLength;
                let x = 0;

                for (let i = 0; i < this.bufferLength; i++) {
                    const v = this.dataArray[i] / 128.0;
                    const y = v * this.canvas.height / 2;

                    if (i === 0) {
                        this.canvasCtx.moveTo(x, y);
                    } else {
                        this.canvasCtx.lineTo(x, y);
                    }

                    x += sliceWidth;
                }

                this.canvasCtx.lineTo(this.canvas.width, this.canvas.height / 2); // Close the path
                this.canvasCtx.strokeStyle = 'white'; // Set the color
                this.canvasCtx.stroke();

                requestAnimationFrame(() => this.drawVisualizer());
            }
        }


        const synth1 = new Synthesizer(1);
        const synth2 = new Synthesizer(2);
        const synth3 = new Synthesizer(3);


        // ... (Your Freesound API interaction code) ...
    </script>
</body>
</html>
